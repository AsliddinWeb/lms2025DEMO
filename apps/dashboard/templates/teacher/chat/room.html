{% extends "components/teacher-base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow-sm border-0">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">{{ room.title }}</h4>
                <small class="text-muted">{{ room.description }}</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                {% if is_owner %}
                    <span class="badge bg-primary">ðŸ‘‘ Owner</span>
                    <a href="{% url 'close_room' room.room_id %}" 
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('Roomni yopmoqchimisiz?')">
                        Roomni Yopish
                    </a>
                {% endif %}
                {% if is_host %}
                    <span class="badge bg-warning text-dark">ðŸŽ¯ Host</span>
                {% endif %}
                <a href="{% url 'dashboard:home' %}" class="btn btn-sm btn-secondary">Chiqish</a>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="root" style="width:100%; height:75vh;"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/@zegocloud/zego-uikit-prebuilt/zego-uikit-prebuilt.js"></script>
<script>
    window.onload = function () {
        const roomID = "{{ room.room_id }}";
        const userID = "{{ user_id }}";
        const userName = "{{ username }}";
        const appID = {{ app_id }};
        const serverSecret = "{{ server_secret }}";
        const isOwner = {{ is_owner|lower }};
        const isHost = {{ is_host|lower }};
        
        const kitToken = ZegoUIKitPrebuilt.generateKitTokenForTest(
            appID, 
            serverSecret, 
            roomID, 
            userID, 
            userName
        );
        
        const zp = ZegoUIKitPrebuilt.create(kitToken);
        
        const config = {
            container: document.querySelector("#root"),
            sharedLinks: [{
                name: 'Room havolasi',
                url: window.location.href,
            }],
            scenario: {
                mode: ZegoUIKitPrebuilt.VideoConference,
            },
            turnOnMicrophoneWhenJoining: true,
            turnOnCameraWhenJoining: true,
            showMyCameraToggleButton: true,
            showMyMicrophoneToggleButton: true,
            showAudioVideoSettingsButton: true,
            showScreenSharingButton: isHost || isOwner,
            showTextChat: true,
            showUserList: true,
            maxUsers: {{ room.max_participants }},
            layout: "Auto",
            showLayoutButton: true,
        };
        
        if (isOwner) {
            config.showLeavingView = false;
        }
        
        zp.joinRoom(config);
    };
</script>
{% endblock %}
